name: ðŸš€ Deploy .NET Backend to VPS (pull vÃ o /root/deploy)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v3

      - name: ðŸ›  Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: ðŸš€ SSH to VPS and deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -T -o StrictHostKeyChecking=no $VPS_USERNAME@$VPS_HOST << 'EOF'
            cd /root/deploy

            # Náº¿u lÃ  láº§n Ä‘áº§u thÃ¬ clone, náº¿u cÃ³ rá»“i thÃ¬ pull
            if [ ! -d .git ]; then
              git git clone https://github.com/chuong2610/deploy.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi

            # Dá»«ng container cÅ©
            docker compose down || true

            # XoÃ¡ image cÅ© náº¿u cáº§n
            docker image prune -f || true

            # Build & cháº¡y container má»›i
            docker compose up -d --build
          EOF
