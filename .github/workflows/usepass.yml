name: ðŸš€ Deploy .NET Backend to VPS Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v3

      - name: ðŸ›  Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: ðŸš€ Deploy to VPS
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PASS: ${{ secrets.PASS }}
          # KhÃ´ng cáº§n khai bÃ¡o cÃ¡c biáº¿n khÃ¡c náº¿u Ä‘Ã£ dÃ¹ng trong Docker Compose

        run: |
          sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_IP /bin/bash << 'EOSSH'
          set -euo pipefail

          DEPLOY_DIR="/root/deploy"
          REPO_URL="https://github.com/chuong2610/deploy.git"

          echo "ðŸ“ Kiá»ƒm tra thÆ° má»¥c deploy..."
          if [ ! -d "$DEPLOY_DIR/.git" ]; then
            echo "ðŸ“¦ Clone repo láº§n Ä‘áº§u..."
            git clone "$REPO_URL" "$DEPLOY_DIR"
          fi

          cd "$DEPLOY_DIR"
          echo "ðŸ”„ KÃ©o code má»›i nháº¥t..."
          git fetch
          git reset --hard origin/main

          echo "ðŸ§¹ Dá»«ng container cÅ©..."
          docker compose down || true

          echo "ðŸš€ Khá»Ÿi Ä‘á»™ng láº¡i container..."
          docker compose up -d --build

          echo "ðŸ§¹ Dá»n dáº¹p Docker cache..."
          docker image prune -af

          echo "âœ… Triá»ƒn khai thÃ nh cÃ´ng!"
          EOSSH
