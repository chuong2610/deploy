name: ðŸš€ Deploy .NET Backend to VPS (pull vÃ o /root/deploy)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v3

      - name: ðŸ›  Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: ðŸš€ SSH to VPS and deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}

          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          JWT_KEY: ${{ secrets.JWT_KEY }}
          JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
          JWT_AUDIENCE: ${{ secrets.JWT_AUDIENCE }}
          DB_CONNECTION: ${{ secrets.DB_CONNECTION }}
          REDIS_CONNECTION: ${{ secrets.REDIS_CONNECTION }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_SMTP: ${{ secrets.EMAIL_SMTP }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

        run: |
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no $VPS_USERNAME@$VPS_HOST <<EOF
            set -e

            echo "ðŸ“ Tá»›i thÆ° má»¥c /root/deploy"
            if [ ! -d "/root/deploy/.git" ]; then
              echo "ðŸ†• Clone repository láº§n Ä‘áº§u"
              git clone https://github.com/chuong2610/deploy.git /root/deploy
            fi

            cd /root/deploy
            echo "ðŸ”„ Pull code má»›i nháº¥t"
            git fetch origin
            git reset --hard origin/main

            echo "ðŸ“ Ghi file .env tá»« GitHub Secrets"
            echo "APP_BASE_URL='${APP_BASE_URL}'" > .env
            echo "JWT_KEY='${JWT_KEY}'" >> .env
            echo "JWT_ISSUER='${JWT_ISSUER}'" >> .env
            echo "JWT_AUDIENCE='${JWT_AUDIENCE}'" >> .env
            echo "DB_CONNECTION='${DB_CONNECTION}'" >> .env
            echo "REDIS_CONNECTION='${REDIS_CONNECTION}'" >> .env
            echo "EMAIL_FROM='${EMAIL_FROM}'" >> .env
            echo "EMAIL_USERNAME='${EMAIL_USERNAME}'" >> .env
            echo "EMAIL_PASSWORD='${EMAIL_PASSWORD}'" >> .env
            echo "EMAIL_PORT='${EMAIL_PORT}'" >> .env
            echo "EMAIL_SMTP='${EMAIL_SMTP}'" >> .env
            echo "GOOGLE_CLIENT_ID='${GOOGLE_CLIENT_ID}'" >> .env
            echo "GOOGLE_CLIENT_SECRET='${GOOGLE_CLIENT_SECRET}'" >> .env

            echo "ðŸ§¹ Dá»«ng container cÅ© náº¿u cÃ³"
            docker compose down || true

            echo "ðŸš€ Build & cháº¡y láº¡i container"
            docker compose up -d --build

            echo "âœ… Deploy thÃ nh cÃ´ng!"
          EOF
