name: 🚀 Deploy .NET Backend to VPS Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ✅ Checkout code
        uses: actions/checkout@v3

      - name: 🛠 Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: 🚀 Deploy to VPS
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
          VPS_USER: ${{ secrets.VPS_USER }}
          PASS: ${{ secrets.PASS }}
          # Không cần khai báo các biến khác nếu đã dùng trong Docker Compose

        run: |
          sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_IP /bin/bash << 'EOSSH'
          set -euo pipefail

          DEPLOY_DIR="/root/deploy"
          REPO_URL="https://github.com/chuong2610/deploy.git"

          echo "📁 Kiểm tra thư mục deploy..."
          if [ ! -d "$DEPLOY_DIR/.git" ]; then
            echo "📦 Clone repo lần đầu..."
            git clone "$REPO_URL" "$DEPLOY_DIR"
          fi

          cd "$DEPLOY_DIR"
          echo "🔄 Kéo code mới nhất..."
          git fetch
          git reset --hard origin/main

          echo "🧹 Dừng container cũ..."
          docker compose down || true

          echo "🚀 Khởi động lại container..."
          docker compose up -d --build

          echo "🧹 Dọn dẹp Docker cache..."
          docker image prune -af

          echo "✅ Triển khai thành công!"
          EOSSH
